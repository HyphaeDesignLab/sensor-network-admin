<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Photo Capture</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<div id='results'>
    <div>
        Tap on video to take a PHOTO
        <video autoplay style="height: 480px; width: 600px;"></video>
        <br/>
        <button id='videoPlay'>Play</button>
        <button id='videoStop' disabled>Stop</button>
        <button id='clearLog'>Clear Log</button>
        <button id='ocrBtn' disabled>OCR</button>
        <button id='flipCamera'>Flip Camera</button>
        <br/>
        <span></span>
        <br/>
        <canvas id='takePhotoCanvas' style="height: 480px; width: 600px;"></canvas>

    </div>
</div>
<script>
  const errorLog = document.querySelector('span');
  const log = (...data) => {
      errorLog.innerHTML = errorLog.innerHTML + '<br/>' + JSON.stringify(Array.from(data), null, 2);
  }
  const clearLogBtn = document.querySelector('#clearLog');
  clearLogBtn.addEventListener('click', () => { errorLog.innerHTML = ''; });

  const videoCameras = [];
  let currentVideoCameraIndex = 0;

  const flipCameraBtn = document.querySelector('#flipCamera');
  navigator.mediaDevices.enumerateDevices().then(devices => {
      log(devices);
      devices.forEach(device => {
          if (device.kind === 'videoinput') {
              videoCameras.push(device);
          }
      });
      if (videoCameras.length <= 1) {
          flipCameraBtn.style.display = 'none';
      }
  });
  flipCameraBtn.addEventListener('click', () => {
      currentVideoCameraIndex = (currentVideoCameraIndex + 1) % videoCameras.length;
      videoPlayer.pause();
      initVideoCapture();
  });

  const videoPlayer = document.querySelector('video');
  const videoPlayerPlayBtn = document.querySelector('#videoPlay');
  const videoPlayerStopBtn = document.querySelector('#videoStop');

  videoPlayerPlayBtn.addEventListener('click', () => {
      videoPlayer.play();
      videoPlayerStopBtn.disabled = false;
      videoPlayerPlayBtn.disabled = true;
  });
  videoPlayerStopBtn.addEventListener('click', () => {
      videoPlayer.pause();
      videoPlayerStopBtn.disabled = true;
      videoPlayerPlayBtn.disabled = false;
  });


  const imageProps = {width: 0, height: 0};
  let imageCapture;

  function initVideoCapture() {
      if (videoCameras.length > 1) {
          log('requesting camera', videoCameras[currentVideoCameraIndex].label, videoCameras[currentVideoCameraIndex].deviceId);
      }
      navigator.mediaDevices.getUserMedia({
        video: videoCameras.length > 1 ? {
          deviceId: videoCameras[currentVideoCameraIndex].deviceId,
          width: {
              min: 1280
          },
          height: {
              min: 720
          }
        } : true,
        audio: false
      })
      // navigator.mediaDevices.getUserMedia({video: videoCameras.length > 1 ? { facingMode: 'environment' } : true})
          .then(mediaStream => {
              log('video tracks count', mediaStream.getVideoTracks().length);
              document.querySelector('video').srcObject = mediaStream;

              const track = mediaStream.getVideoTracks()[0];
              imageCapture = new ImageCapture(track);

              return imageCapture.getPhotoCapabilities();
          })
          .then(photoCapabilities => {
              const settings = imageCapture.track.getSettings();

              imageProps.width = (photoCapabilities.imageWidth.min + photoCapabilities.imageWidth.max) / 2;
              log(photoCapabilities.imageWidth.min, photoCapabilities.imageWidth.max)
              return imageCapture.getPhotoSettings();
          })
          .then(photoSettings => {
              log(photoSettings.imageWidth)
              imageProps.width = photoSettings.imageWidth;
          })
          .catch(error => log('Argh!', error.name || error));
  }
  initVideoCapture();

  function onTakePhotoButtonClick() {
    imageCapture.takePhoto({imageWidth: imageProps.width})
            .then(blob => createImageBitmap(blob))
            .then(imageBitmap => {
              drawCanvas(imageBitmap);
              ocrBtn.disabled = false;
              log(`Photo size is ${imageBitmap.width}x${imageBitmap.height}`);
            })
            .catch(error => log(error));
  }
  videoPlayer.addEventListener('click', onTakePhotoButtonClick);


  const ocrBtn = document.querySelector('#ocrBtn');
  ocrBtn.addEventListener('click', () => {
      const formData = new FormData();
      formData.append('apikey', 'K83508668988957')
      formData.append('base64Image', lastPhotoTaken)
      formData.append('detectOrientation', true)
      formData.append('filetype', 'image/jpg')

      fetch('https://api.ocr.space/parse/image', {
          method: 'post',
          body: formData
      })
        .then(response => response.json())
        .then(json => log(json));
  })

  /* Utils */
  let lastPhotoTaken = '';
  function drawCanvas(img) {
    const canvas = document.querySelector('canvas#takePhotoCanvas');
    canvas.width = getComputedStyle(canvas).width.split('px')[0];
    canvas.height = getComputedStyle(canvas).height.split('px')[0];
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    const [width, height] = getImgDimensionsFitInBox(img, canvas.width, canvas.height);
    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
    log('canvas dimensions', canvas.width, canvas.height);
    log('image resized dimensions', width, height);
    log(lastPhotoTaken = canvas.toDataURL('image/jpg'));
    log(img);
  }

  const getImgDimensionsFitInBox = (img, MAX_WIDTH, MAX_HEIGHT) => {
      var width = img.width;
      var height = img.height;
      if (width > height) {
          if (width > MAX_WIDTH) {
              height = height * (MAX_WIDTH / width);
              width = MAX_WIDTH;
          }
      } else {
          if (height > MAX_HEIGHT) {
              width = width * (MAX_HEIGHT / height);
              height = MAX_HEIGHT;
          }
      }
      return [width, height];
  }
</script>
</body>
</html>